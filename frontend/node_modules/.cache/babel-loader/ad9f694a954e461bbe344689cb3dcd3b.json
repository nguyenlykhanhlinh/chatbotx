{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\MyPC\\\\Documents\\\\chatbot\\\\frontend\\\\src\\\\components\\\\Chatbot\\\\Chatbot.tsx\",\n    _s2 = $RefreshSig$();\n\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport './Chatbot.css';\nimport { useCart } from '../../context/CartContext';\nimport OrderForm from '../OrderForm';\nimport { FiSend, FiShoppingCart } from 'react-icons/fi';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\n\nconst Chatbot = () => {\n  _s2();\n\n  var _s = $RefreshSig$();\n\n  const [isOpen, setIsOpen] = useState(false);\n  const [messages, setMessages] = useState([]);\n  const [inputMessage, setInputMessage] = useState('');\n  const [ws, setWs] = useState(null);\n  const [connectionStatus, setConnectionStatus] = useState('disconnected');\n  const [retryCount, setRetryCount] = useState(0);\n  const [showOrderForm, setShowOrderForm] = useState(false);\n  const [selectedProduct, setSelectedProduct] = useState(null);\n  const MAX_RETRIES = 5;\n  const RETRY_INTERVALS = [1000, 2000, 3000, 5000, 8000];\n  const messagesEndRef = useRef(null);\n  const wsRef = useRef(null);\n  const shouldReconnect = useRef(true);\n  const {\n    state: cartState\n  } = useCart();\n  const scrollToBottom = useCallback(() => {\n    var _messagesEndRef$curre;\n\n    (_messagesEndRef$curre = messagesEndRef.current) === null || _messagesEndRef$curre === void 0 ? void 0 : _messagesEndRef$curre.scrollIntoView({\n      behavior: 'smooth'\n    });\n  }, []);\n  const addMessage = useCallback((text, isUser, response) => {\n    setMessages(prev => [...prev, {\n      text,\n      isUser,\n      timestamp: new Date(),\n      response: response ? {\n        message: response.message,\n        product_details: response.product_details || null,\n        order_status: response.order_status\n      } : undefined\n    }]);\n  }, []);\n  const connectWebSocket = useCallback(() => {\n    var _wsRef$current;\n\n    if (!shouldReconnect.current) return;\n\n    if (((_wsRef$current = wsRef.current) === null || _wsRef$current === void 0 ? void 0 : _wsRef$current.readyState) === WebSocket.OPEN) {\n      console.log('WebSocket already connected');\n      return;\n    }\n\n    try {\n      console.log(`Attempting to connect (attempt ${retryCount + 1}/${MAX_RETRIES})...`);\n      setConnectionStatus('connecting');\n      const websocket = new WebSocket('ws://localhost:8000/ws/chat');\n      wsRef.current = websocket; // Thiết lập ping interval để giữ kết nối\n\n      let pingInterval;\n\n      websocket.onopen = () => {\n        console.log('✅ Connected to WebSocket');\n        setConnectionStatus('connected');\n        setWs(websocket);\n        setRetryCount(0); // Bắt đầu gửi ping mỗi 30 giây\n\n        pingInterval = setInterval(() => {\n          if (websocket.readyState === WebSocket.OPEN) {\n            websocket.send(JSON.stringify({\n              type: 'ping'\n            }));\n          }\n        }, 30000);\n      };\n\n      websocket.onmessage = event => {\n        console.log('📩 Received message:', event.data);\n\n        try {\n          const data = JSON.parse(event.data);\n\n          if (data.type === 'ping' || data.type === 'pong') {\n            console.log(`📍 Received ${data.type}`);\n            return;\n          }\n\n          if (data.type === 'message' && data.ai_response) {\n            const response = data.ai_response.response;\n            console.log('🤖 AI Response:', response);\n\n            if (response.error) {\n              addMessage('Xin lỗi, có lỗi xảy ra. Vui lòng thử lại sau.', false);\n              return;\n            } // Thêm message vào chat\n\n\n            addMessage(response.message, false, {\n              message: response.message,\n              product_details: response.product_details,\n              order_status: response.order_status\n            }); // Nếu là order_status = true thì cập nhật message cuối cùng\n\n            if (response.order_status === true) {\n              console.log('🛍️ Order status is true, updating last message...');\n              setMessages(prevMessages => {\n                const lastOrderFormIndex = [...prevMessages].reverse().findIndex(msg => {\n                  var _msg$response;\n\n                  return !msg.isUser && ((_msg$response = msg.response) === null || _msg$response === void 0 ? void 0 : _msg$response.order_status);\n                });\n\n                if (lastOrderFormIndex !== -1) {\n                  const messages = [...prevMessages];\n                  const actualIndex = messages.length - 1 - lastOrderFormIndex;\n                  messages[actualIndex] = { ...messages[actualIndex],\n                    response: { ...messages[actualIndex].response,\n                      message: response.message\n                    }\n                  };\n                  return messages;\n                }\n\n                return [...prevMessages];\n              });\n            }\n          }\n        } catch (error) {\n          console.error('❌ Error processing message:', error);\n          addMessage('Xin lỗi, có lỗi xảy ra khi xử lý tin nhắn.', false);\n        }\n      };\n\n      websocket.onerror = error => {\n        console.log('❌ WebSocket error:', error);\n        setConnectionStatus('disconnected');\n        clearInterval(pingInterval);\n      };\n\n      websocket.onclose = event => {\n        console.log('🔴 WebSocket connection closed', event);\n        setConnectionStatus('disconnected');\n        setWs(null);\n        clearInterval(pingInterval);\n\n        if (shouldReconnect.current && retryCount < MAX_RETRIES) {\n          const timeout = RETRY_INTERVALS[retryCount] || RETRY_INTERVALS[RETRY_INTERVALS.length - 1];\n          console.log(`🔄 Retrying in ${timeout}ms...`);\n          setTimeout(() => {\n            setRetryCount(prev => prev + 1);\n            connectWebSocket();\n          }, timeout);\n        } else if (retryCount >= MAX_RETRIES) {\n          console.log('❌ Max retries exceeded');\n          shouldReconnect.current = false;\n          addMessage('Xin lỗi, không thể kết nối đến server. Vui lòng thử lại sau.', false);\n        }\n      };\n    } catch (error) {\n      console.error('Error creating WebSocket:', error);\n      setConnectionStatus('disconnected');\n    }\n  }, [retryCount, addMessage]);\n\n  const toggleChat = () => {\n    const newIsOpen = !isOpen;\n    setIsOpen(newIsOpen);\n\n    if (newIsOpen) {\n      shouldReconnect.current = true;\n\n      if (connectionStatus === 'disconnected') {\n        setRetryCount(0);\n        connectWebSocket();\n      }\n    } else {\n      var _wsRef$current2;\n\n      shouldReconnect.current = false;\n\n      if (((_wsRef$current2 = wsRef.current) === null || _wsRef$current2 === void 0 ? void 0 : _wsRef$current2.readyState) === WebSocket.OPEN) {\n        wsRef.current.close();\n      }\n\n      setConnectionStatus('disconnected');\n      setWs(null);\n      setRetryCount(0);\n    }\n  };\n\n  useEffect(() => {\n    if (isOpen && connectionStatus === 'disconnected' && shouldReconnect.current) {\n      connectWebSocket();\n    }\n\n    return () => {\n      var _wsRef$current3;\n\n      shouldReconnect.current = false;\n\n      if (((_wsRef$current3 = wsRef.current) === null || _wsRef$current3 === void 0 ? void 0 : _wsRef$current3.readyState) === WebSocket.OPEN) {\n        wsRef.current.close();\n      }\n    };\n  }, [isOpen]);\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages, scrollToBottom]);\n\n  const handleSubmit = e => {\n    e.preventDefault();\n    if (!inputMessage.trim()) return;\n\n    if (connectionStatus !== 'connected') {\n      addMessage('Đang kết nối lại với server...', false);\n      return;\n    } // Tối ưu hóa dữ liệu gửi đi\n\n\n    const messageToSend = {\n      type: 'message',\n      data: {\n        text: inputMessage,\n        cart: cartState.items.length > 0 ? cartState.items.map(item => ({\n          name: item.title,\n          price: item.price.replace(/[^0-9]/g, ''),\n          qty: item.quantity\n        })) : []\n      }\n    };\n\n    try {\n      ws === null || ws === void 0 ? void 0 : ws.send(JSON.stringify(messageToSend));\n      addMessage(inputMessage, true);\n      setInputMessage('');\n    } catch (error) {\n      console.error('Error sending message:', error);\n      addMessage('Không thể gửi tin nhắn. Vui lòng thử lại.', false);\n    }\n  };\n\n  const ProductWidget = _ref => {\n    _s();\n\n    let {\n      products\n    } = _ref;\n    const {\n      dispatch\n    } = useCart();\n    const [currentIndex, setCurrentIndex] = useState(0);\n\n    const handlePrevious = () => {\n      setCurrentIndex(prev => prev === 0 ? products.length - 1 : prev - 1);\n    };\n\n    const handleNext = () => {\n      setCurrentIndex(prev => prev === products.length - 1 ? 0 : prev + 1);\n    };\n\n    const formatPrice = price => {\n      if (!price) return \"Liên hệ\";\n      const numericPrice = price.replace(/[^0-9]/g, '');\n      if (!numericPrice) return price;\n\n      try {\n        return new Intl.NumberFormat('vi-VN', {\n          style: 'currency',\n          currency: 'VND'\n        }).format(Number(numericPrice));\n      } catch (error) {\n        console.error('Error formatting price:', error);\n        return price;\n      }\n    };\n\n    const handleAddToCart = product => {\n      dispatch({\n        type: 'ADD_TO_CART',\n        item: {\n          id: product.url || String(Date.now()),\n          title: product.name,\n          price: product.price || '0',\n          imageURL: product.image_url || '/placeholder.png',\n          quantity: 1\n        }\n      });\n    };\n\n    if (!products || products.length === 0) {\n      return null;\n    }\n\n    const currentProduct = products[currentIndex];\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"bg-white rounded-lg shadow-md overflow-hidden my-2 max-w-sm\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"w-full h-48 relative\",\n        children: [products.length > 1 && /*#__PURE__*/_jsxDEV(_Fragment, {\n          children: [/*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: handlePrevious,\n            className: \"absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\",\n            title: \"Previous product\",\n            children: \"\\u2190\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 302,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: handleNext,\n            className: \"absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\",\n            title: \"Next product\",\n            children: \"\\u2192\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 309,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true), currentProduct.image_url ? /*#__PURE__*/_jsxDEV(\"img\", {\n          src: currentProduct.image_url,\n          alt: currentProduct.name,\n          onError: e => {\n            console.log('Image failed to load for product:', currentProduct);\n            e.currentTarget.src = '/placeholder.png';\n          },\n          className: \"w-full h-full object-contain\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 321,\n          columnNumber: 13\n        }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-full h-full flex items-center justify-center bg-gray-100\",\n          children: /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-gray-400\",\n            children: \"No image available\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 332,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 331,\n          columnNumber: 13\n        }, this), products.length > 1 && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-2 py-1 rounded-full text-sm\",\n          children: [currentIndex + 1, \" / \", products.length]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 338,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 298,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"p-4\",\n        children: [/*#__PURE__*/_jsxDEV(\"h4\", {\n          className: \"text-lg font-semibold mb-2 line-clamp-2\",\n          children: currentProduct.name\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 345,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex items-center justify-between\",\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-blue-600 font-bold\",\n            children: formatPrice(currentProduct.price)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 347,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: () => handleAddToCart(currentProduct),\n            className: \"p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors\",\n            title: \"Th\\xEAm v\\xE0o gi\\u1ECF h\\xE0ng\",\n            children: /*#__PURE__*/_jsxDEV(FiShoppingCart, {\n              size: 20\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 355,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 350,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 346,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 344,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 297,\n      columnNumber: 7\n    }, this);\n  };\n\n  _s(ProductWidget, \"+h5Dx1vYTtyTtdRnxW4L8wCqOlk=\", false, function () {\n    return [useCart];\n  });\n\n  const handleAIResponse = response => {\n    // Hiển thị message và suggestions như bình thường\n    addMessage(response.message, false); // Kiểm tra order_status\n\n    if (response.order_status) {\n      if (cartState.items.length === 0) {\n        // Giỏ hàng trống\n        addMessage(\"Giỏ hàng của bạn đang trống. Hãy thêm sản phẩm trước khi đặt hàng!\", false);\n      } else {\n        // Hiển thị form đặt hàng\n        setShowOrderForm(true);\n      }\n    }\n  };\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: `chatbot-container ${isOpen ? 'open' : ''}`,\n    children: [/*#__PURE__*/_jsxDEV(\"button\", {\n      className: \"chat-toggle\",\n      onClick: toggleChat,\n      title: \"M\\u1EDF chat\",\n      children: isOpen ? '✕' : '💬'\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 381,\n      columnNumber: 7\n    }, this), isOpen && /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-window\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-header\",\n        children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n          children: \"Chat v\\u1EDBi AI\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 388,\n          columnNumber: 13\n        }, this), cartState.items.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"cart-info\",\n          children: [\"\\uD83D\\uDED2 \", cartState.items.length, \" s\\u1EA3n ph\\u1EA9m\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 390,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 387,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"messages-container\",\n        children: [messages.map((msg, index) => {\n          var _msg$response2, _msg$response3;\n\n          return /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `message ${msg.isUser ? 'user-message' : 'bot-message'}`,\n            children: [msg.text && /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"message-content\",\n              children: msg.text\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 399,\n              columnNumber: 30\n            }, this), !msg.isUser && ((_msg$response2 = msg.response) === null || _msg$response2 === void 0 ? void 0 : _msg$response2.product_details) && /*#__PURE__*/_jsxDEV(ProductWidget, {\n              products: msg.response.product_details\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 402,\n              columnNumber: 19\n            }, this), !msg.isUser && ((_msg$response3 = msg.response) === null || _msg$response3 === void 0 ? void 0 : _msg$response3.order_status) && cartState.items.length > 0 && /*#__PURE__*/_jsxDEV(OrderForm, {\n              onClose: () => {\n                setShowOrderForm(false);\n              },\n              cartItems: cartState.items,\n              onSubmit: formData => {\n                const message = `Cảm ơn bạn đã đặt hàng!\\n\\nThông tin đơn hàng:\\nHọ tên: ${formData.name}\\nSĐT: ${formData.phone}\\nĐịa chỉ: ${formData.address}\\n${formData.note ? `Ghi chú: ${formData.note}` : ''}`;\n                addMessage(message, false);\n              }\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 406,\n              columnNumber: 19\n            }, this)]\n          }, index, true, {\n            fileName: _jsxFileName,\n            lineNumber: 398,\n            columnNumber: 15\n          }, this);\n        }), /*#__PURE__*/_jsxDEV(\"div\", {\n          ref: messagesEndRef\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 419,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 396,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n        onSubmit: handleSubmit,\n        className: \"input-form\",\n        children: [/*#__PURE__*/_jsxDEV(\"input\", {\n          type: \"text\",\n          value: inputMessage,\n          onChange: e => setInputMessage(e.target.value),\n          placeholder: \"Nh\\u1EADp tin nh\\u1EAFn...\",\n          className: \"message-input\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 423,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          type: \"submit\",\n          className: \"send-button\",\n          title: \"G\\u1EEDi tin nh\\u1EAFn\",\n          children: /*#__PURE__*/_jsxDEV(FiSend, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 431,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 430,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 422,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 386,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 380,\n    columnNumber: 5\n  }, this);\n};\n\n_s2(Chatbot, \"NlYoT/qL7WYTbsGITQ80t6NFaDk=\", false, function () {\n  return [useCart];\n});\n\n_c = Chatbot;\nexport default Chatbot;\n\nvar _c;\n\n$RefreshReg$(_c, \"Chatbot\");","map":{"version":3,"names":["React","useState","useEffect","useRef","useCallback","useCart","OrderForm","FiSend","FiShoppingCart","Chatbot","isOpen","setIsOpen","messages","setMessages","inputMessage","setInputMessage","ws","setWs","connectionStatus","setConnectionStatus","retryCount","setRetryCount","showOrderForm","setShowOrderForm","selectedProduct","setSelectedProduct","MAX_RETRIES","RETRY_INTERVALS","messagesEndRef","wsRef","shouldReconnect","state","cartState","scrollToBottom","current","scrollIntoView","behavior","addMessage","text","isUser","response","prev","timestamp","Date","message","product_details","order_status","undefined","connectWebSocket","readyState","WebSocket","OPEN","console","log","websocket","pingInterval","onopen","setInterval","send","JSON","stringify","type","onmessage","event","data","parse","ai_response","error","prevMessages","lastOrderFormIndex","reverse","findIndex","msg","actualIndex","length","onerror","clearInterval","onclose","timeout","setTimeout","toggleChat","newIsOpen","close","handleSubmit","e","preventDefault","trim","messageToSend","cart","items","map","item","name","title","price","replace","qty","quantity","ProductWidget","products","dispatch","currentIndex","setCurrentIndex","handlePrevious","handleNext","formatPrice","numericPrice","Intl","NumberFormat","style","currency","format","Number","handleAddToCart","product","id","url","String","now","imageURL","image_url","currentProduct","currentTarget","src","handleAIResponse","index","formData","phone","address","note","target","value"],"sources":["C:/Users/MyPC/Documents/chatbot/frontend/src/components/Chatbot/Chatbot.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport './Chatbot.css';\r\nimport { useCart } from '../../context/CartContext';\r\nimport OrderForm from '../OrderForm';\r\nimport { FiSend, FiShoppingCart } from 'react-icons/fi';\r\n\r\ninterface ProductDetails {\r\n  name: string;\r\n  price?: string;\r\n  description?: string;\r\n  image_url?: string;\r\n  url?: string;\r\n}\r\n\r\ninterface ChatResponse {\r\n  message: string;\r\n  product_details: ProductDetails[] | null;\r\n  order_status?: boolean;\r\n}\r\n\r\ninterface Message {\r\n  text: string;\r\n  isUser: boolean;\r\n  timestamp: Date;\r\n  response?: ChatResponse;\r\n}\r\n\r\nconst Chatbot: React.FC = () => {\r\n  const [isOpen, setIsOpen] = useState<boolean>(false);\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [inputMessage, setInputMessage] = useState<string>('');\r\n  const [ws, setWs] = useState<WebSocket | null>(null);\r\n  const [connectionStatus, setConnectionStatus] = useState<'connecting' | 'connected' | 'disconnected'>('disconnected');\r\n  const [retryCount, setRetryCount] = useState(0);\r\n  const [showOrderForm, setShowOrderForm] = useState(false);\r\n  const [selectedProduct, setSelectedProduct] = useState<ProductDetails | null>(null);\r\n  const MAX_RETRIES = 5;\r\n  const RETRY_INTERVALS = [1000, 2000, 3000, 5000, 8000];\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n  const shouldReconnect = useRef<boolean>(true);\r\n  const { state: cartState } = useCart();\r\n\r\n  const scrollToBottom = useCallback(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, []);\r\n\r\n  const addMessage = useCallback((text: string, isUser: boolean, response?: ChatResponse) => {\r\n    setMessages(prev => [...prev, { \r\n      text, \r\n      isUser, \r\n      timestamp: new Date(), \r\n      response: response ? {\r\n        message: response.message,\r\n        product_details: response.product_details || null,\r\n        order_status: response.order_status\r\n      } : undefined\r\n    }]);\r\n  }, []);\r\n\r\n  const connectWebSocket = useCallback(() => {\r\n    if (!shouldReconnect.current) return;\r\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n      console.log('WebSocket already connected');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      console.log(`Attempting to connect (attempt ${retryCount + 1}/${MAX_RETRIES})...`);\r\n      setConnectionStatus('connecting');\r\n\r\n      const websocket = new WebSocket('ws://localhost:8000/ws/chat');\r\n      wsRef.current = websocket;\r\n\r\n      // Thiết lập ping interval để giữ kết nối\r\n      let pingInterval: NodeJS.Timeout;\r\n\r\n      websocket.onopen = () => {\r\n        console.log('✅ Connected to WebSocket');\r\n        setConnectionStatus('connected');\r\n        setWs(websocket);\r\n        setRetryCount(0);\r\n\r\n        // Bắt đầu gửi ping mỗi 30 giây\r\n        pingInterval = setInterval(() => {\r\n          if (websocket.readyState === WebSocket.OPEN) {\r\n            websocket.send(JSON.stringify({ type: 'ping' }));\r\n          }\r\n        }, 30000);\r\n      };\r\n\r\n      websocket.onmessage = (event) => {\r\n        console.log('📩 Received message:', event.data);\r\n        try {\r\n          const data = JSON.parse(event.data);\r\n          \r\n          if (data.type === 'ping' || data.type === 'pong') {\r\n            console.log(`📍 Received ${data.type}`);\r\n            return;\r\n          }\r\n\r\n          if (data.type === 'message' && data.ai_response) {\r\n            const response = data.ai_response.response;\r\n            console.log('🤖 AI Response:', response);\r\n            \r\n            if (response.error) {\r\n              addMessage('Xin lỗi, có lỗi xảy ra. Vui lòng thử lại sau.', false);\r\n              return;\r\n            }\r\n            \r\n            // Thêm message vào chat\r\n            addMessage(response.message, false, {\r\n              message: response.message,\r\n              product_details: response.product_details,\r\n              order_status: response.order_status\r\n            });\r\n\r\n            // Nếu là order_status = true thì cập nhật message cuối cùng\r\n            if (response.order_status === true) {\r\n              console.log('🛍️ Order status is true, updating last message...');\r\n              setMessages(prevMessages => {\r\n                const lastOrderFormIndex = [...prevMessages].reverse().findIndex(msg => \r\n                  !msg.isUser && msg.response?.order_status\r\n                );\r\n                \r\n                if (lastOrderFormIndex !== -1) {\r\n                  const messages = [...prevMessages];\r\n                  const actualIndex = messages.length - 1 - lastOrderFormIndex;\r\n                  messages[actualIndex] = {\r\n                    ...messages[actualIndex],\r\n                    response: {\r\n                      ...messages[actualIndex].response!,\r\n                      message: response.message\r\n                    }\r\n                  };\r\n                  return messages;\r\n                }\r\n                return [...prevMessages];\r\n              });\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('❌ Error processing message:', error);\r\n          addMessage('Xin lỗi, có lỗi xảy ra khi xử lý tin nhắn.', false);\r\n        }\r\n      };\r\n\r\n      websocket.onerror = (error) => {\r\n        console.log('❌ WebSocket error:', error);\r\n        setConnectionStatus('disconnected');\r\n        clearInterval(pingInterval);\r\n      };\r\n\r\n      websocket.onclose = (event) => {\r\n        console.log('🔴 WebSocket connection closed', event);\r\n        setConnectionStatus('disconnected');\r\n        setWs(null);\r\n        clearInterval(pingInterval);\r\n\r\n        if (shouldReconnect.current && retryCount < MAX_RETRIES) {\r\n          const timeout = RETRY_INTERVALS[retryCount] || RETRY_INTERVALS[RETRY_INTERVALS.length - 1];\r\n          console.log(`🔄 Retrying in ${timeout}ms...`);\r\n          setTimeout(() => {\r\n            setRetryCount(prev => prev + 1);\r\n            connectWebSocket();\r\n          }, timeout);\r\n        } else if (retryCount >= MAX_RETRIES) {\r\n          console.log('❌ Max retries exceeded');\r\n          shouldReconnect.current = false;\r\n          addMessage('Xin lỗi, không thể kết nối đến server. Vui lòng thử lại sau.', false);\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('Error creating WebSocket:', error);\r\n      setConnectionStatus('disconnected');\r\n    }\r\n  }, [retryCount, addMessage]);\r\n\r\n  const toggleChat = () => {\r\n    const newIsOpen = !isOpen;\r\n    setIsOpen(newIsOpen);\r\n    \r\n    if (newIsOpen) {\r\n      shouldReconnect.current = true;\r\n      if (connectionStatus === 'disconnected') {\r\n        setRetryCount(0);\r\n        connectWebSocket();\r\n      }\r\n    } else {\r\n      shouldReconnect.current = false;\r\n      if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n        wsRef.current.close();\r\n      }\r\n      setConnectionStatus('disconnected');\r\n      setWs(null);\r\n      setRetryCount(0);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (isOpen && connectionStatus === 'disconnected' && shouldReconnect.current) {\r\n      connectWebSocket();\r\n    }\r\n\r\n    return () => {\r\n      shouldReconnect.current = false;\r\n      if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n        wsRef.current.close();\r\n      }\r\n    };\r\n  }, [isOpen]);\r\n\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages, scrollToBottom]);\r\n\r\n  const handleSubmit = (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!inputMessage.trim()) return;\r\n    \r\n    if (connectionStatus !== 'connected') {\r\n      addMessage('Đang kết nối lại với server...', false);\r\n      return;\r\n    }\r\n\r\n    // Tối ưu hóa dữ liệu gửi đi\r\n    const messageToSend = {\r\n      type: 'message',\r\n      data: {\r\n        text: inputMessage,\r\n        cart: cartState.items.length > 0 ? cartState.items.map(item => ({\r\n          name: item.title,\r\n          price: item.price.replace(/[^0-9]/g, ''),\r\n          qty: item.quantity\r\n        })) : []\r\n      }\r\n    };\r\n\r\n    try {\r\n      ws?.send(JSON.stringify(messageToSend));\r\n      addMessage(inputMessage, true);\r\n      setInputMessage('');\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n      addMessage('Không thể gửi tin nhắn. Vui lòng thử lại.', false);\r\n    }\r\n  };\r\n\r\n  const ProductWidget: React.FC<{ products: ProductDetails[] }> = ({ products }) => {\r\n    const { dispatch } = useCart();\r\n    const [currentIndex, setCurrentIndex] = useState(0);\r\n    \r\n    const handlePrevious = () => {\r\n      setCurrentIndex((prev) => (prev === 0 ? products.length - 1 : prev - 1));\r\n    };\r\n\r\n    const handleNext = () => {\r\n      setCurrentIndex((prev) => (prev === products.length - 1 ? 0 : prev + 1));\r\n    };\r\n\r\n    const formatPrice = (price: string | undefined) => {\r\n      if (!price) return \"Liên hệ\";\r\n      const numericPrice = price.replace(/[^0-9]/g, '');\r\n      if (!numericPrice) return price;\r\n      \r\n      try {\r\n        return new Intl.NumberFormat('vi-VN', { \r\n          style: 'currency', \r\n          currency: 'VND' \r\n        }).format(Number(numericPrice));\r\n      } catch (error) {\r\n        console.error('Error formatting price:', error);\r\n        return price;\r\n      }\r\n    };\r\n\r\n    const handleAddToCart = (product: ProductDetails) => {\r\n      dispatch({\r\n        type: 'ADD_TO_CART',\r\n        item: {\r\n          id: product.url || String(Date.now()),\r\n          title: product.name,\r\n          price: product.price || '0',\r\n          imageURL: product.image_url || '/placeholder.png',\r\n          quantity: 1\r\n        }\r\n      });\r\n    };\r\n\r\n    if (!products || products.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const currentProduct = products[currentIndex];\r\n\r\n    return (\r\n      <div className=\"bg-white rounded-lg shadow-md overflow-hidden my-2 max-w-sm\">\r\n        <div className=\"w-full h-48 relative\">\r\n          {/* Navigation Buttons */}\r\n          {products.length > 1 && (\r\n            <>\r\n              <button\r\n                onClick={handlePrevious}\r\n                className=\"absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\"\r\n                title=\"Previous product\"\r\n              >\r\n                ←\r\n              </button>\r\n              <button\r\n                onClick={handleNext}\r\n                className=\"absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\"\r\n                title=\"Next product\"\r\n              >\r\n                →\r\n              </button>\r\n            </>\r\n          )}\r\n          \r\n          {/* Product Image */}\r\n          {currentProduct.image_url ? (\r\n            <img \r\n              src={currentProduct.image_url}\r\n              alt={currentProduct.name}\r\n              onError={(e) => {\r\n                console.log('Image failed to load for product:', currentProduct);\r\n                e.currentTarget.src = '/placeholder.png';\r\n              }}\r\n              className=\"w-full h-full object-contain\"\r\n            />\r\n          ) : (\r\n            <div className=\"w-full h-full flex items-center justify-center bg-gray-100\">\r\n              <span className=\"text-gray-400\">No image available</span>\r\n            </div>\r\n          )}\r\n          \r\n          {/* Product Counter */}\r\n          {products.length > 1 && (\r\n            <div className=\"absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-2 py-1 rounded-full text-sm\">\r\n              {currentIndex + 1} / {products.length}\r\n            </div>\r\n          )}\r\n        </div>\r\n        \r\n        <div className=\"p-4\">\r\n          <h4 className=\"text-lg font-semibold mb-2 line-clamp-2\">{currentProduct.name}</h4>\r\n          <div className=\"flex items-center justify-between\">\r\n            <span className=\"text-blue-600 font-bold\">\r\n              {formatPrice(currentProduct.price)}\r\n            </span>\r\n            <button \r\n              onClick={() => handleAddToCart(currentProduct)}\r\n              className=\"p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors\"\r\n              title=\"Thêm vào giỏ hàng\"\r\n            >\r\n              <FiShoppingCart size={20} />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const handleAIResponse = (response: ChatResponse) => {\r\n    // Hiển thị message và suggestions như bình thường\r\n    addMessage(response.message, false);\r\n\r\n    // Kiểm tra order_status\r\n    if (response.order_status) {\r\n      if (cartState.items.length === 0) {\r\n        // Giỏ hàng trống\r\n        addMessage(\"Giỏ hàng của bạn đang trống. Hãy thêm sản phẩm trước khi đặt hàng!\", false);\r\n      } else {\r\n        // Hiển thị form đặt hàng\r\n        setShowOrderForm(true);\r\n      }\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className={`chatbot-container ${isOpen ? 'open' : ''}`}>\r\n      <button className=\"chat-toggle\" onClick={toggleChat} title=\"Mở chat\">\r\n        {isOpen ? '✕' : '💬'}\r\n      </button>\r\n      \r\n      {isOpen && (\r\n        <div className=\"chat-window\">\r\n          <div className=\"chat-header\">\r\n            <h3>Chat với AI</h3>\r\n            {cartState.items.length > 0 && (\r\n              <div className=\"cart-info\">\r\n                🛒 {cartState.items.length} sản phẩm\r\n              </div>\r\n            )}\r\n          </div>\r\n          \r\n          <div className=\"messages-container\">\r\n            {messages.map((msg, index) => (\r\n              <div key={index} className={`message ${msg.isUser ? 'user-message' : 'bot-message'}`}>\r\n                {msg.text && <div className=\"message-content\">{msg.text}</div>}\r\n                \r\n                {!msg.isUser && msg.response?.product_details && (\r\n                  <ProductWidget products={msg.response.product_details} />\r\n                )}\r\n\r\n                {!msg.isUser && msg.response?.order_status && cartState.items.length > 0 && (\r\n                  <OrderForm\r\n                    onClose={() => {\r\n                      setShowOrderForm(false);\r\n                    }}\r\n                    cartItems={cartState.items}\r\n                    onSubmit={(formData) => {\r\n                      const message = `Cảm ơn bạn đã đặt hàng!\\n\\nThông tin đơn hàng:\\nHọ tên: ${formData.name}\\nSĐT: ${formData.phone}\\nĐịa chỉ: ${formData.address}\\n${formData.note ? `Ghi chú: ${formData.note}` : ''}`;\r\n                      addMessage(message, false);\r\n                    }}\r\n                  />\r\n                )}\r\n              </div>\r\n            ))}\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n          \r\n          <form onSubmit={handleSubmit} className=\"input-form\">\r\n            <input\r\n              type=\"text\"\r\n              value={inputMessage}\r\n              onChange={(e) => setInputMessage(e.target.value)}\r\n              placeholder=\"Nhập tin nhắn...\"\r\n              className=\"message-input\"\r\n            />\r\n            <button type=\"submit\" className=\"send-button\" title=\"Gửi tin nhắn\">\r\n              <FiSend />\r\n            </button>\r\n          </form>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Chatbot; "],"mappings":"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"},"metadata":{},"sourceType":"module"}