{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\MyPC\\\\Documents\\\\chatbot\\\\frontend\\\\src\\\\components\\\\Chatbot\\\\Chatbot.tsx\",\n    _s2 = $RefreshSig$();\n\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport './Chatbot.css';\nimport { useCart } from '../../context/CartContext';\nimport OrderForm from '../OrderForm';\nimport { FiSend, FiShoppingCart } from 'react-icons/fi';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\n\nconst Chatbot = () => {\n  _s2();\n\n  var _s = $RefreshSig$();\n\n  const [isOpen, setIsOpen] = useState(false);\n  const [messages, setMessages] = useState([]);\n  const [inputMessage, setInputMessage] = useState('');\n  const [ws, setWs] = useState(null);\n  const [connectionStatus, setConnectionStatus] = useState('disconnected');\n  const [retryCount, setRetryCount] = useState(0);\n  const [showOrderForm, setShowOrderForm] = useState(false);\n  const [selectedProduct, setSelectedProduct] = useState(null);\n  const MAX_RETRIES = 5;\n  const RETRY_INTERVALS = [1000, 2000, 3000, 5000, 8000];\n  const messagesEndRef = useRef(null);\n  const wsRef = useRef(null);\n  const shouldReconnect = useRef(true);\n  const {\n    state: cartState\n  } = useCart();\n  const scrollToBottom = useCallback(() => {\n    var _messagesEndRef$curre;\n\n    (_messagesEndRef$curre = messagesEndRef.current) === null || _messagesEndRef$curre === void 0 ? void 0 : _messagesEndRef$curre.scrollIntoView({\n      behavior: 'smooth'\n    });\n  }, []);\n  const addMessage = useCallback((text, isUser, response) => {\n    setMessages(prev => [...prev, {\n      text,\n      isUser,\n      timestamp: new Date(),\n      response: response ? {\n        message: response.message,\n        product_details: response.product_details || null,\n        order_status: response.order_status\n      } : undefined\n    }]);\n  }, []);\n  const connectWebSocket = useCallback(() => {\n    var _wsRef$current;\n\n    if (!shouldReconnect.current) return;\n\n    if (((_wsRef$current = wsRef.current) === null || _wsRef$current === void 0 ? void 0 : _wsRef$current.readyState) === WebSocket.OPEN) {\n      console.log('WebSocket already connected');\n      return;\n    }\n\n    try {\n      console.log(`Attempting to connect (attempt ${retryCount + 1}/${MAX_RETRIES})...`);\n      setConnectionStatus('connecting');\n      const websocket = new WebSocket('ws://localhost:8000/ws/chat');\n      wsRef.current = websocket;\n\n      websocket.onopen = () => {\n        console.log('✅ Connected to WebSocket');\n        setConnectionStatus('connected');\n        setWs(websocket);\n        setRetryCount(0);\n      };\n\n      websocket.onmessage = event => {\n        console.log('📩 Received message:', event.data);\n\n        try {\n          const data = JSON.parse(event.data);\n\n          if (data.type === 'ping') {\n            console.log('📍 Received ping, sending pong...');\n            websocket.send(JSON.stringify({\n              type: 'pong'\n            }));\n            return;\n          }\n\n          if (data.type === 'message' && data.ai_response) {\n            const response = data.ai_response.response;\n            console.log('🤖 AI Response:', response); // Thêm message vào chat\n\n            addMessage(response.message, false, {\n              message: response.message,\n              product_details: response.product_details,\n              order_status: response.order_status\n            }); // Nếu là order_status = true thì cập nhật message cuối cùng thay vì thêm mới\n\n            if (response.order_status === true) {\n              console.log('🛍️ Order status is true, updating last message...');\n              setMessages(prevMessages => {\n                // Tìm message cuối cùng có order form\n                const lastOrderFormIndex = [...prevMessages].reverse().findIndex(msg => {\n                  var _msg$response;\n\n                  return !msg.isUser && ((_msg$response = msg.response) === null || _msg$response === void 0 ? void 0 : _msg$response.order_status);\n                });\n\n                if (lastOrderFormIndex !== -1) {\n                  // Nếu đã có order form, cập nhật message đó\n                  const messages = [...prevMessages];\n                  const actualIndex = messages.length - 1 - lastOrderFormIndex;\n                  messages[actualIndex] = { ...messages[actualIndex],\n                    response: { ...messages[actualIndex].response,\n                      message: response.message\n                    }\n                  };\n                  return messages;\n                } // Nếu chưa có order form, thêm mới\n\n\n                return [...prevMessages];\n              });\n            }\n          }\n        } catch (error) {\n          console.error('❌ Error processing message:', error);\n        }\n      };\n\n      websocket.onerror = error => {\n        console.log('❌ WebSocket error:', error);\n        setConnectionStatus('disconnected');\n      };\n\n      websocket.onclose = event => {\n        console.log('🔴 WebSocket connection closed', event);\n        setConnectionStatus('disconnected');\n        setWs(null);\n\n        if (shouldReconnect.current && retryCount < MAX_RETRIES) {\n          const timeout = RETRY_INTERVALS[retryCount] || RETRY_INTERVALS[RETRY_INTERVALS.length - 1];\n          console.log(`🔄 Retrying in ${timeout}ms...`);\n          setTimeout(() => {\n            setRetryCount(prev => prev + 1);\n            connectWebSocket();\n          }, timeout);\n        } else if (retryCount >= MAX_RETRIES) {\n          console.log('❌ Max retries exceeded');\n          shouldReconnect.current = false;\n          addMessage('Xin lỗi, không thể kết nối đến server. Vui lòng thử lại sau.', false);\n        }\n      };\n    } catch (error) {\n      console.error('Error creating WebSocket:', error);\n      setConnectionStatus('disconnected');\n    }\n  }, [retryCount, addMessage]);\n\n  const toggleChat = () => {\n    const newIsOpen = !isOpen;\n    setIsOpen(newIsOpen);\n\n    if (newIsOpen) {\n      shouldReconnect.current = true;\n\n      if (connectionStatus === 'disconnected') {\n        setRetryCount(0);\n        connectWebSocket();\n      }\n    } else {\n      var _wsRef$current2;\n\n      shouldReconnect.current = false;\n\n      if (((_wsRef$current2 = wsRef.current) === null || _wsRef$current2 === void 0 ? void 0 : _wsRef$current2.readyState) === WebSocket.OPEN) {\n        wsRef.current.close();\n      }\n\n      setConnectionStatus('disconnected');\n      setWs(null);\n      setRetryCount(0);\n    }\n  };\n\n  useEffect(() => {\n    if (isOpen && connectionStatus === 'disconnected' && shouldReconnect.current) {\n      connectWebSocket();\n    }\n\n    return () => {\n      var _wsRef$current3;\n\n      shouldReconnect.current = false;\n\n      if (((_wsRef$current3 = wsRef.current) === null || _wsRef$current3 === void 0 ? void 0 : _wsRef$current3.readyState) === WebSocket.OPEN) {\n        wsRef.current.close();\n      }\n    };\n  }, [isOpen]);\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages, scrollToBottom]);\n\n  const handleSubmit = e => {\n    e.preventDefault();\n    if (!inputMessage.trim()) return;\n\n    if (connectionStatus !== 'connected') {\n      addMessage('Đang kết nối lại với server...', false);\n      return;\n    } // Chỉ gửi thông tin cần thiết của cart items\n\n\n    const simplifiedCartItems = cartState.items.map(item => ({\n      t: item.title,\n      // Rút gọn tên trường\n      p: item.price,\n      // Rút gọn tên trường\n      q: item.quantity // Rút gọn tên trường\n\n    })); // Gửi dữ liệu đã được tối ưu\n\n    const messageData = {\n      m: inputMessage,\n      // Rút gọn tên trường\n      c: simplifiedCartItems.length > 0 ? simplifiedCartItems : undefined // Rút gọn tên trường\n\n    };\n    console.log('📤 Sending message:', messageData);\n    ws === null || ws === void 0 ? void 0 : ws.send(JSON.stringify(messageData));\n    addMessage(inputMessage, true);\n    setInputMessage('');\n  };\n\n  const ProductWidget = _ref => {\n    _s();\n\n    let {\n      products\n    } = _ref;\n    const {\n      dispatch\n    } = useCart();\n    const [currentIndex, setCurrentIndex] = useState(0);\n\n    const handlePrevious = () => {\n      setCurrentIndex(prev => prev === 0 ? products.length - 1 : prev - 1);\n    };\n\n    const handleNext = () => {\n      setCurrentIndex(prev => prev === products.length - 1 ? 0 : prev + 1);\n    };\n\n    const formatPrice = price => {\n      if (!price) return \"Liên hệ\";\n      const numericPrice = price.replace(/[^0-9]/g, '');\n      if (!numericPrice) return price;\n\n      try {\n        return new Intl.NumberFormat('vi-VN', {\n          style: 'currency',\n          currency: 'VND'\n        }).format(Number(numericPrice));\n      } catch (error) {\n        console.error('Error formatting price:', error);\n        return price;\n      }\n    };\n\n    const handleAddToCart = product => {\n      dispatch({\n        type: 'ADD_TO_CART',\n        item: {\n          id: product.url || String(Date.now()),\n          title: product.name,\n          price: product.price || '0',\n          imageURL: product.image_url || '/placeholder.png',\n          quantity: 1\n        }\n      });\n    };\n\n    if (!products || products.length === 0) {\n      return null;\n    }\n\n    const currentProduct = products[currentIndex];\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"bg-white rounded-lg shadow-md overflow-hidden my-2 max-w-sm\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"w-full h-48 relative\",\n        children: [products.length > 1 && /*#__PURE__*/_jsxDEV(_Fragment, {\n          children: [/*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: handlePrevious,\n            className: \"absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\",\n            title: \"Previous product\",\n            children: \"\\u2190\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 286,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: handleNext,\n            className: \"absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\",\n            title: \"Next product\",\n            children: \"\\u2192\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 293,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true), currentProduct.image_url ? /*#__PURE__*/_jsxDEV(\"img\", {\n          src: currentProduct.image_url,\n          alt: currentProduct.name,\n          onError: e => {\n            console.log('Image failed to load for product:', currentProduct);\n            e.currentTarget.src = '/placeholder.png';\n          },\n          className: \"w-full h-full object-contain\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 305,\n          columnNumber: 13\n        }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-full h-full flex items-center justify-center bg-gray-100\",\n          children: /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-gray-400\",\n            children: \"No image available\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 316,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 315,\n          columnNumber: 13\n        }, this), products.length > 1 && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-2 py-1 rounded-full text-sm\",\n          children: [currentIndex + 1, \" / \", products.length]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 322,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 282,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"p-4\",\n        children: [/*#__PURE__*/_jsxDEV(\"h4\", {\n          className: \"text-lg font-semibold mb-2 line-clamp-2\",\n          children: currentProduct.name\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 329,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex items-center justify-between\",\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-blue-600 font-bold\",\n            children: formatPrice(currentProduct.price)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 331,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: () => handleAddToCart(currentProduct),\n            className: \"p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors\",\n            title: \"Th\\xEAm v\\xE0o gi\\u1ECF h\\xE0ng\",\n            children: /*#__PURE__*/_jsxDEV(FiShoppingCart, {\n              size: 20\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 339,\n              columnNumber: 15\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 334,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 330,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 328,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 281,\n      columnNumber: 7\n    }, this);\n  };\n\n  _s(ProductWidget, \"+h5Dx1vYTtyTtdRnxW4L8wCqOlk=\", false, function () {\n    return [useCart];\n  });\n\n  const handleAIResponse = response => {\n    // Hiển thị message và suggestions như bình thường\n    addMessage(response.message, false); // Kiểm tra order_status\n\n    if (response.order_status) {\n      if (cartState.items.length === 0) {\n        // Giỏ hàng trống\n        addMessage(\"Giỏ hàng của bạn đang trống. Hãy thêm sản phẩm trước khi đặt hàng!\", false);\n      } else {\n        // Hiển thị form đặt hàng\n        setShowOrderForm(true);\n      }\n    }\n  };\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: `chatbot-container ${isOpen ? 'open' : ''}`,\n    children: [/*#__PURE__*/_jsxDEV(\"button\", {\n      className: \"chat-toggle\",\n      onClick: toggleChat,\n      title: \"M\\u1EDF chat\",\n      children: isOpen ? '✕' : '💬'\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 365,\n      columnNumber: 7\n    }, this), isOpen && /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-window\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"chat-header\",\n        children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n          children: \"Chat v\\u1EDBi AI\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 372,\n          columnNumber: 13\n        }, this), cartState.items.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"cart-info\",\n          children: [\"\\uD83D\\uDED2 \", cartState.items.length, \" s\\u1EA3n ph\\u1EA9m\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 374,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 371,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"messages-container\",\n        children: [messages.map((msg, index) => {\n          var _msg$response2, _msg$response3;\n\n          return /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `message ${msg.isUser ? 'user-message' : 'bot-message'}`,\n            children: [msg.text && /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"message-content\",\n              children: msg.text\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 383,\n              columnNumber: 30\n            }, this), !msg.isUser && ((_msg$response2 = msg.response) === null || _msg$response2 === void 0 ? void 0 : _msg$response2.product_details) && /*#__PURE__*/_jsxDEV(ProductWidget, {\n              products: msg.response.product_details\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 386,\n              columnNumber: 19\n            }, this), !msg.isUser && ((_msg$response3 = msg.response) === null || _msg$response3 === void 0 ? void 0 : _msg$response3.order_status) && cartState.items.length > 0 && /*#__PURE__*/_jsxDEV(OrderForm, {\n              onClose: () => {\n                setShowOrderForm(false);\n              },\n              cartItems: cartState.items,\n              onSubmit: formData => {\n                const message = `Cảm ơn bạn đã đặt hàng!\\n\\nThông tin đơn hàng:\\nHọ tên: ${formData.name}\\nSĐT: ${formData.phone}\\nĐịa chỉ: ${formData.address}\\n${formData.note ? `Ghi chú: ${formData.note}` : ''}`;\n                addMessage(message, false);\n              }\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 390,\n              columnNumber: 19\n            }, this)]\n          }, index, true, {\n            fileName: _jsxFileName,\n            lineNumber: 382,\n            columnNumber: 15\n          }, this);\n        }), /*#__PURE__*/_jsxDEV(\"div\", {\n          ref: messagesEndRef\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 403,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 380,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n        onSubmit: handleSubmit,\n        className: \"input-form\",\n        children: [/*#__PURE__*/_jsxDEV(\"input\", {\n          type: \"text\",\n          value: inputMessage,\n          onChange: e => setInputMessage(e.target.value),\n          placeholder: \"Nh\\u1EADp tin nh\\u1EAFn...\",\n          className: \"message-input\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 407,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          type: \"submit\",\n          className: \"send-button\",\n          title: \"G\\u1EEDi tin nh\\u1EAFn\",\n          children: /*#__PURE__*/_jsxDEV(FiSend, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 415,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 414,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 406,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 370,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 364,\n    columnNumber: 5\n  }, this);\n};\n\n_s2(Chatbot, \"NlYoT/qL7WYTbsGITQ80t6NFaDk=\", false, function () {\n  return [useCart];\n});\n\n_c = Chatbot;\nexport default Chatbot;\n\nvar _c;\n\n$RefreshReg$(_c, \"Chatbot\");","map":{"version":3,"names":["React","useState","useEffect","useRef","useCallback","useCart","OrderForm","FiSend","FiShoppingCart","Chatbot","isOpen","setIsOpen","messages","setMessages","inputMessage","setInputMessage","ws","setWs","connectionStatus","setConnectionStatus","retryCount","setRetryCount","showOrderForm","setShowOrderForm","selectedProduct","setSelectedProduct","MAX_RETRIES","RETRY_INTERVALS","messagesEndRef","wsRef","shouldReconnect","state","cartState","scrollToBottom","current","scrollIntoView","behavior","addMessage","text","isUser","response","prev","timestamp","Date","message","product_details","order_status","undefined","connectWebSocket","readyState","WebSocket","OPEN","console","log","websocket","onopen","onmessage","event","data","JSON","parse","type","send","stringify","ai_response","prevMessages","lastOrderFormIndex","reverse","findIndex","msg","actualIndex","length","error","onerror","onclose","timeout","setTimeout","toggleChat","newIsOpen","close","handleSubmit","e","preventDefault","trim","simplifiedCartItems","items","map","item","t","title","p","price","q","quantity","messageData","m","c","ProductWidget","products","dispatch","currentIndex","setCurrentIndex","handlePrevious","handleNext","formatPrice","numericPrice","replace","Intl","NumberFormat","style","currency","format","Number","handleAddToCart","product","id","url","String","now","name","imageURL","image_url","currentProduct","currentTarget","src","handleAIResponse","index","formData","phone","address","note","target","value"],"sources":["C:/Users/MyPC/Documents/chatbot/frontend/src/components/Chatbot/Chatbot.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport './Chatbot.css';\r\nimport { useCart } from '../../context/CartContext';\r\nimport OrderForm from '../OrderForm';\r\nimport { FiSend, FiShoppingCart } from 'react-icons/fi';\r\n\r\ninterface ProductDetails {\r\n  name: string;\r\n  price?: string;\r\n  description?: string;\r\n  image_url?: string;\r\n  url?: string;\r\n}\r\n\r\ninterface ChatResponse {\r\n  message: string;\r\n  product_details: ProductDetails[] | null;\r\n  order_status?: boolean;\r\n}\r\n\r\ninterface Message {\r\n  text: string;\r\n  isUser: boolean;\r\n  timestamp: Date;\r\n  response?: ChatResponse;\r\n}\r\n\r\nconst Chatbot: React.FC = () => {\r\n  const [isOpen, setIsOpen] = useState<boolean>(false);\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [inputMessage, setInputMessage] = useState<string>('');\r\n  const [ws, setWs] = useState<WebSocket | null>(null);\r\n  const [connectionStatus, setConnectionStatus] = useState<'connecting' | 'connected' | 'disconnected'>('disconnected');\r\n  const [retryCount, setRetryCount] = useState(0);\r\n  const [showOrderForm, setShowOrderForm] = useState(false);\r\n  const [selectedProduct, setSelectedProduct] = useState<ProductDetails | null>(null);\r\n  const MAX_RETRIES = 5;\r\n  const RETRY_INTERVALS = [1000, 2000, 3000, 5000, 8000];\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n  const shouldReconnect = useRef<boolean>(true);\r\n  const { state: cartState } = useCart();\r\n\r\n  const scrollToBottom = useCallback(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, []);\r\n\r\n  const addMessage = useCallback((text: string, isUser: boolean, response?: ChatResponse) => {\r\n    setMessages(prev => [...prev, { \r\n      text, \r\n      isUser, \r\n      timestamp: new Date(), \r\n      response: response ? {\r\n        message: response.message,\r\n        product_details: response.product_details || null,\r\n        order_status: response.order_status\r\n      } : undefined\r\n    }]);\r\n  }, []);\r\n\r\n  const connectWebSocket = useCallback(() => {\r\n    if (!shouldReconnect.current) return;\r\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n      console.log('WebSocket already connected');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      console.log(`Attempting to connect (attempt ${retryCount + 1}/${MAX_RETRIES})...`);\r\n      setConnectionStatus('connecting');\r\n\r\n      const websocket = new WebSocket('ws://localhost:8000/ws/chat');\r\n      wsRef.current = websocket;\r\n\r\n      websocket.onopen = () => {\r\n        console.log('✅ Connected to WebSocket');\r\n        setConnectionStatus('connected');\r\n        setWs(websocket);\r\n        setRetryCount(0);\r\n      };\r\n\r\n      websocket.onmessage = (event) => {\r\n        console.log('📩 Received message:', event.data);\r\n        try {\r\n          const data = JSON.parse(event.data);\r\n          \r\n          if (data.type === 'ping') {\r\n            console.log('📍 Received ping, sending pong...');\r\n            websocket.send(JSON.stringify({ type: 'pong' }));\r\n            return;\r\n          }\r\n\r\n          if (data.type === 'message' && data.ai_response) {\r\n            const response = data.ai_response.response;\r\n            console.log('🤖 AI Response:', response);\r\n            \r\n            // Thêm message vào chat\r\n            addMessage(response.message, false, {\r\n              message: response.message,\r\n              product_details: response.product_details,\r\n              order_status: response.order_status\r\n            });\r\n\r\n            // Nếu là order_status = true thì cập nhật message cuối cùng thay vì thêm mới\r\n            if (response.order_status === true) {\r\n              console.log('🛍️ Order status is true, updating last message...');\r\n              setMessages(prevMessages => {\r\n                // Tìm message cuối cùng có order form\r\n                const lastOrderFormIndex = [...prevMessages].reverse().findIndex(msg => \r\n                  !msg.isUser && msg.response?.order_status\r\n                );\r\n                \r\n                if (lastOrderFormIndex !== -1) {\r\n                  // Nếu đã có order form, cập nhật message đó\r\n                  const messages = [...prevMessages];\r\n                  const actualIndex = messages.length - 1 - lastOrderFormIndex;\r\n                  messages[actualIndex] = {\r\n                    ...messages[actualIndex],\r\n                    response: {\r\n                      ...messages[actualIndex].response!,\r\n                      message: response.message\r\n                    }\r\n                  };\r\n                  return messages;\r\n                }\r\n                \r\n                // Nếu chưa có order form, thêm mới\r\n                return [...prevMessages];\r\n              });\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('❌ Error processing message:', error);\r\n        }\r\n      };\r\n\r\n      websocket.onerror = (error) => {\r\n        console.log('❌ WebSocket error:', error);\r\n        setConnectionStatus('disconnected');\r\n      };\r\n\r\n      websocket.onclose = (event) => {\r\n        console.log('🔴 WebSocket connection closed', event);\r\n        setConnectionStatus('disconnected');\r\n        setWs(null);\r\n\r\n        if (shouldReconnect.current && retryCount < MAX_RETRIES) {\r\n          const timeout = RETRY_INTERVALS[retryCount] || RETRY_INTERVALS[RETRY_INTERVALS.length - 1];\r\n          console.log(`🔄 Retrying in ${timeout}ms...`);\r\n          setTimeout(() => {\r\n            setRetryCount(prev => prev + 1);\r\n            connectWebSocket();\r\n          }, timeout);\r\n        } else if (retryCount >= MAX_RETRIES) {\r\n          console.log('❌ Max retries exceeded');\r\n          shouldReconnect.current = false;\r\n          addMessage('Xin lỗi, không thể kết nối đến server. Vui lòng thử lại sau.', false);\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('Error creating WebSocket:', error);\r\n      setConnectionStatus('disconnected');\r\n    }\r\n  }, [retryCount, addMessage]);\r\n\r\n  const toggleChat = () => {\r\n    const newIsOpen = !isOpen;\r\n    setIsOpen(newIsOpen);\r\n    \r\n    if (newIsOpen) {\r\n      shouldReconnect.current = true;\r\n      if (connectionStatus === 'disconnected') {\r\n        setRetryCount(0);\r\n        connectWebSocket();\r\n      }\r\n    } else {\r\n      shouldReconnect.current = false;\r\n      if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n        wsRef.current.close();\r\n      }\r\n      setConnectionStatus('disconnected');\r\n      setWs(null);\r\n      setRetryCount(0);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (isOpen && connectionStatus === 'disconnected' && shouldReconnect.current) {\r\n      connectWebSocket();\r\n    }\r\n\r\n    return () => {\r\n      shouldReconnect.current = false;\r\n      if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n        wsRef.current.close();\r\n      }\r\n    };\r\n  }, [isOpen]);\r\n\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages, scrollToBottom]);\r\n\r\n  const handleSubmit = (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!inputMessage.trim()) return;\r\n    \r\n    if (connectionStatus !== 'connected') {\r\n      addMessage('Đang kết nối lại với server...', false);\r\n      return;\r\n    }\r\n\r\n    // Chỉ gửi thông tin cần thiết của cart items\r\n    const simplifiedCartItems = cartState.items.map(item => ({\r\n      t: item.title,        // Rút gọn tên trường\r\n      p: item.price,        // Rút gọn tên trường\r\n      q: item.quantity      // Rút gọn tên trường\r\n    }));\r\n\r\n    // Gửi dữ liệu đã được tối ưu\r\n    const messageData = {\r\n      m: inputMessage,      // Rút gọn tên trường\r\n      c: simplifiedCartItems.length > 0 ? simplifiedCartItems : undefined  // Rút gọn tên trường\r\n    };\r\n\r\n    console.log('📤 Sending message:', messageData);\r\n    ws?.send(JSON.stringify(messageData));\r\n    \r\n    addMessage(inputMessage, true);\r\n    setInputMessage('');\r\n  };\r\n\r\n  const ProductWidget: React.FC<{ products: ProductDetails[] }> = ({ products }) => {\r\n    const { dispatch } = useCart();\r\n    const [currentIndex, setCurrentIndex] = useState(0);\r\n    \r\n    const handlePrevious = () => {\r\n      setCurrentIndex((prev) => (prev === 0 ? products.length - 1 : prev - 1));\r\n    };\r\n\r\n    const handleNext = () => {\r\n      setCurrentIndex((prev) => (prev === products.length - 1 ? 0 : prev + 1));\r\n    };\r\n\r\n    const formatPrice = (price: string | undefined) => {\r\n      if (!price) return \"Liên hệ\";\r\n      const numericPrice = price.replace(/[^0-9]/g, '');\r\n      if (!numericPrice) return price;\r\n      \r\n      try {\r\n        return new Intl.NumberFormat('vi-VN', { \r\n          style: 'currency', \r\n          currency: 'VND' \r\n        }).format(Number(numericPrice));\r\n      } catch (error) {\r\n        console.error('Error formatting price:', error);\r\n        return price;\r\n      }\r\n    };\r\n\r\n    const handleAddToCart = (product: ProductDetails) => {\r\n      dispatch({\r\n        type: 'ADD_TO_CART',\r\n        item: {\r\n          id: product.url || String(Date.now()),\r\n          title: product.name,\r\n          price: product.price || '0',\r\n          imageURL: product.image_url || '/placeholder.png',\r\n          quantity: 1\r\n        }\r\n      });\r\n    };\r\n\r\n    if (!products || products.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const currentProduct = products[currentIndex];\r\n\r\n    return (\r\n      <div className=\"bg-white rounded-lg shadow-md overflow-hidden my-2 max-w-sm\">\r\n        <div className=\"w-full h-48 relative\">\r\n          {/* Navigation Buttons */}\r\n          {products.length > 1 && (\r\n            <>\r\n              <button\r\n                onClick={handlePrevious}\r\n                className=\"absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\"\r\n                title=\"Previous product\"\r\n              >\r\n                ←\r\n              </button>\r\n              <button\r\n                onClick={handleNext}\r\n                className=\"absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-md hover:bg-white transition-colors z-10\"\r\n                title=\"Next product\"\r\n              >\r\n                →\r\n              </button>\r\n            </>\r\n          )}\r\n          \r\n          {/* Product Image */}\r\n          {currentProduct.image_url ? (\r\n            <img \r\n              src={currentProduct.image_url}\r\n              alt={currentProduct.name}\r\n              onError={(e) => {\r\n                console.log('Image failed to load for product:', currentProduct);\r\n                e.currentTarget.src = '/placeholder.png';\r\n              }}\r\n              className=\"w-full h-full object-contain\"\r\n            />\r\n          ) : (\r\n            <div className=\"w-full h-full flex items-center justify-center bg-gray-100\">\r\n              <span className=\"text-gray-400\">No image available</span>\r\n            </div>\r\n          )}\r\n          \r\n          {/* Product Counter */}\r\n          {products.length > 1 && (\r\n            <div className=\"absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-2 py-1 rounded-full text-sm\">\r\n              {currentIndex + 1} / {products.length}\r\n            </div>\r\n          )}\r\n        </div>\r\n        \r\n        <div className=\"p-4\">\r\n          <h4 className=\"text-lg font-semibold mb-2 line-clamp-2\">{currentProduct.name}</h4>\r\n          <div className=\"flex items-center justify-between\">\r\n            <span className=\"text-blue-600 font-bold\">\r\n              {formatPrice(currentProduct.price)}\r\n            </span>\r\n            <button \r\n              onClick={() => handleAddToCart(currentProduct)}\r\n              className=\"p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors\"\r\n              title=\"Thêm vào giỏ hàng\"\r\n            >\r\n              <FiShoppingCart size={20} />\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const handleAIResponse = (response: ChatResponse) => {\r\n    // Hiển thị message và suggestions như bình thường\r\n    addMessage(response.message, false);\r\n\r\n    // Kiểm tra order_status\r\n    if (response.order_status) {\r\n      if (cartState.items.length === 0) {\r\n        // Giỏ hàng trống\r\n        addMessage(\"Giỏ hàng của bạn đang trống. Hãy thêm sản phẩm trước khi đặt hàng!\", false);\r\n      } else {\r\n        // Hiển thị form đặt hàng\r\n        setShowOrderForm(true);\r\n      }\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className={`chatbot-container ${isOpen ? 'open' : ''}`}>\r\n      <button className=\"chat-toggle\" onClick={toggleChat} title=\"Mở chat\">\r\n        {isOpen ? '✕' : '💬'}\r\n      </button>\r\n      \r\n      {isOpen && (\r\n        <div className=\"chat-window\">\r\n          <div className=\"chat-header\">\r\n            <h3>Chat với AI</h3>\r\n            {cartState.items.length > 0 && (\r\n              <div className=\"cart-info\">\r\n                🛒 {cartState.items.length} sản phẩm\r\n              </div>\r\n            )}\r\n          </div>\r\n          \r\n          <div className=\"messages-container\">\r\n            {messages.map((msg, index) => (\r\n              <div key={index} className={`message ${msg.isUser ? 'user-message' : 'bot-message'}`}>\r\n                {msg.text && <div className=\"message-content\">{msg.text}</div>}\r\n                \r\n                {!msg.isUser && msg.response?.product_details && (\r\n                  <ProductWidget products={msg.response.product_details} />\r\n                )}\r\n\r\n                {!msg.isUser && msg.response?.order_status && cartState.items.length > 0 && (\r\n                  <OrderForm\r\n                    onClose={() => {\r\n                      setShowOrderForm(false);\r\n                    }}\r\n                    cartItems={cartState.items}\r\n                    onSubmit={(formData) => {\r\n                      const message = `Cảm ơn bạn đã đặt hàng!\\n\\nThông tin đơn hàng:\\nHọ tên: ${formData.name}\\nSĐT: ${formData.phone}\\nĐịa chỉ: ${formData.address}\\n${formData.note ? `Ghi chú: ${formData.note}` : ''}`;\r\n                      addMessage(message, false);\r\n                    }}\r\n                  />\r\n                )}\r\n              </div>\r\n            ))}\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n          \r\n          <form onSubmit={handleSubmit} className=\"input-form\">\r\n            <input\r\n              type=\"text\"\r\n              value={inputMessage}\r\n              onChange={(e) => setInputMessage(e.target.value)}\r\n              placeholder=\"Nhập tin nhắn...\"\r\n              className=\"message-input\"\r\n            />\r\n            <button type=\"submit\" className=\"send-button\" title=\"Gửi tin nhắn\">\r\n              <FiSend />\r\n            </button>\r\n          </form>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Chatbot; "],"mappings":"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"},"metadata":{},"sourceType":"module"}